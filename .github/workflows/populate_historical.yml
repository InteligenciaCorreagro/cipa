name: Poblar BD Historica

on:
  workflow_dispatch:
    inputs:
      fecha_desde:
        description: "Fecha desde (YYYY-MM-DD)"
        required: true
        type: string
      fecha_hasta:
        description: "Fecha hasta (YYYY-MM-DD)"
        required: true
        type: string

jobs:
  poblar-historico:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      WORKFLOW_DB_PATH: ./data/notas_credito_historico_workflow.db

    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Crear directorios
        run: mkdir -p data output templates

      - name: Reiniciar base de datos del workflow
        run: rm -f "${WORKFLOW_DB_PATH}"

      - name: Procesar rango historico
        env:
          CONNI_KEY: ${{ secrets.CONNI_KEY }}
          CONNI_TOKEN: ${{ secrets.CONNI_TOKEN }}
          DB_PATH: ${{ env.WORKFLOW_DB_PATH }}
          FECHA_DESDE: ${{ github.event.inputs.fecha_desde }}
          FECHA_HASTA: ${{ github.event.inputs.fecha_hasta }}
        run: |
          python - <<'PY'
          import os
          import sys
          from datetime import datetime

          fecha_desde_raw = os.environ["FECHA_DESDE"].strip()
          fecha_hasta_raw = os.environ["FECHA_HASTA"].strip()

          try:
              fecha_desde = datetime.strptime(fecha_desde_raw, "%Y-%m-%d")
              fecha_hasta = datetime.strptime(fecha_hasta_raw, "%Y-%m-%d")
          except ValueError as exc:
              raise SystemExit(f"Formato de fecha invalido: {exc}")

          if fecha_desde > fecha_hasta:
              raise SystemExit("fecha_desde debe ser menor o igual a fecha_hasta")

          if not os.getenv("CONNI_KEY") or not os.getenv("CONNI_TOKEN"):
              raise SystemExit("Faltan secrets CONNI_KEY y/o CONNI_TOKEN")

          sys.path.insert(0, "backend")
          from main import procesar_rango_fechas

          config = {
              "CONNI_KEY": os.getenv("CONNI_KEY"),
              "CONNI_TOKEN": os.getenv("CONNI_TOKEN"),
              "DB_PATH": os.getenv("DB_PATH", "./data/notas_credito_historico_workflow.db"),
              "TEMPLATE_PATH": "./templates/plantilla.xlsx",
          }

          resultado = procesar_rango_fechas(fecha_desde, fecha_hasta, config)
          if not resultado.get("exito"):
              raise SystemExit(f"El proceso no fue exitoso: {resultado}")

          print("Resumen de procesamiento:")
          print(f"- Dias: {resultado.get('total_dias', 0)}")
          print(f"- Facturas: {resultado.get('total_facturas_procesadas', 0)}")
          print(f"- Notas credito: {resultado.get('total_notas_credito', 0)}")
          print(f"- Rechazadas: {resultado.get('total_facturas_rechazadas', 0)}")
          print(f"- Aplicaciones: {resultado.get('total_aplicaciones', 0)}")
          print(f"- Notas aplicadas: {resultado.get('notas_aplicadas', 0)}")
          print(f"- Notas pendientes: {resultado.get('notas_pendientes', 0)}")
          print(f"- Saldo pendiente: {resultado.get('saldo_pendiente_total', 0.0)}")
          print(f"- Archivo: {resultado.get('archivo_generado', 'N/A')}")
          PY

      - name: Guardar cambios
        env:
          FECHA_DESDE: ${{ github.event.inputs.fecha_desde }}
          FECHA_HASTA: ${{ github.event.inputs.fecha_hasta }}
        run: |
          if [ -f "${WORKFLOW_DB_PATH}" ]; then
            git add "${WORKFLOW_DB_PATH}"
            if ! git diff --staged --quiet; then
              git commit -m "BD historica: ${FECHA_DESDE} a ${FECHA_HASTA}"
              git push
            else
              echo "Sin cambios en la base de datos"
            fi
          fi

      - name: Subir artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: historico-${{ github.run_number }}
          path: output/*.xlsx
          retention-days: 30
