name: Poblar BD Hist贸rica

on:
  workflow_dispatch:
    inputs:
      fecha_desde:
        description: 'Fecha desde (YYYY-MM-DD)'
        required: true
        default: '2025-12-01'
      fecha_hasta:
        description: 'Fecha hasta (YYYY-MM-DD)'
        required: true
        default: '2025-12-07'

jobs:
  poblar-historico:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Descargar c贸digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Crear directorios
        run: mkdir -p data output templates

      - name: Procesar rango hist贸rico
        env:
          CONNI_KEY: ${{ secrets.CONNI_KEY }}
          CONNI_TOKEN: ${{ secrets.CONNI_TOKEN }}
          DB_PATH: ./data/notas_credito.db
          ${{ github.event.inputs.fecha_desde }}: ${{ github.event.inputs.fecha_desde }}
          ${{ github.event.inputs.fecha_hasta }}: ${{ github.event.inputs.fecha_hasta }}
        run: |
          echo "Procesando desde ${{ github.event.inputs.fecha_desde }} hasta ${{ github.event.inputs.fecha_hasta }}"
          python -c "
          import os, sys
          from datetime import datetime
          sys.path.insert(0, 'backend')
          from main import procesar_rango_fechas
          config = {
              'CONNI_KEY': os.getenv('CONNI_KEY'),
              'CONNI_TOKEN': os.getenv('CONNI_TOKEN'),
              'DB_PATH': './data/notas_credito.db',
              'TEMPLATE_PATH': './templates/plantilla.xlsx'
          }
          fd = datetime.strptime(os.getenv('${{ github.event.inputs.fecha_desde }}'), '%Y-%m-%d')
          fh = datetime.strptime(os.getenv('${{ github.event.inputs.fecha_hasta }}'), '%Y-%m-%d')
          resultado = procesar_rango_fechas(fd, fh, config)
          print(f'Dias: {resultado.get(\"total_dias\",0)} | Facturas: {resultado.get(\"total_facturas_procesadas\",0)}')
          "

      - name: Guardar cambios
        env:
          ${{ github.event.inputs.fecha_desde }}: ${{ github.event.inputs.fecha_desde }}
          ${{ github.event.inputs.fecha_hasta }}: ${{ github.event.inputs.fecha_hasta }}
        run: |
          if [ -f data/notas_credito.db ]; then
            git add data/notas_credito.db
            if ! git diff --staged --quiet; then
              git commit -m "BD hist贸rica: ${{ github.event.inputs.fecha_desde }} a ${{ github.event.inputs.fecha_hasta }}"
              git push
            fi
          fi

      - name: Subir artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: historico
          path: output/*.xlsx
          retention-days: 30
