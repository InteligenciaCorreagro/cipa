╔════════════════════════════════════════════════════════════════════════════╗
║                RESUMEN EJECUTIVO - PROYECTO CIPA                           ║
║              Sistema de Gestión de Notas de Crédito Automatizado            ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. ¿QUÉ ES CIPA?                                                            │
└─────────────────────────────────────────────────────────────────────────────┘

Sistema **completamente automatizado** para gestión de notas de crédito que:

  • Extrae facturas diariamente de API SIESA (empresa Correagro)
  • Valida facturas contra 23 tipos de inventario excluidos
  • Rechaza facturas menores a $498,000 COP
  • Registra y aplica automáticamente notas crédito a facturas
  • Genera reportes Excel con facturas procesadas
  • Envía reporte por correo a operativa diariamente
  • Proporciona API REST y frontend web para consultas
  • Controla acceso mediante autenticación JWT

EJECUCIÓN: GitHub Actions → Todos los días 8:00 AM Bogotá (13:00 UTC)
RESULTADO: Correo operativo con archivo Excel + historial en base de datos

┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. FLUJO DIARIO AUTOMATIZADO                                                │
└─────────────────────────────────────────────────────────────────────────────┘

  8:00 AM
   ↓
   ├─ GitHub Actions inicia daily_process.yml
   │
   ├─ 1. OBTENER DATOS
   │   └─ API SIESA → facturas del día anterior
   │
   ├─ 2. VALIDAR
   │   ├─ Rechaza: Tipo inventario excluido (23 tipos)
   │   ├─ Rechaza: Monto < $498,000
   │   └─ Acepta: Resto
   │
   ├─ 3. NOTAS CRÉDITO
   │   ├─ Identifica notas (prefijo 'N')
   │   ├─ Registra en BD SQLite
   │   ├─ Busca facturas para aplicar
   │   └─ Aplica automáticamente si cliente + producto coinciden
   │
   ├─ 4. GENERAR REPORTES
   │   ├─ Excel: facturas_YYYYMMDD.xlsx
   │   ├─ Txt: notas crédito con aplicaciones
   │   └─ Txt: facturas rechazadas con razón
   │
   ├─ 5. ENVIAR CORREO
   │   ├─ A: DESTINATARIOS (config)
   │   ├─ Adjunto: facturas_YYYYMMDD.xlsx
   │   └─ Cuerpo: HTML con fecha y estadísticas
   │
   └─ 6. PERSISTENCIA
       ├─ Commit BD actualizada al repositorio
       ├─ Upload artifacts (Excel 30 días, BD 7 días)
       └─ Log completo en GitHub Actions

┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. COMPONENTES PRINCIPALES                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ BACKEND (Python + Flask) ─────────────────────────────────────────────────┐
│                                                                              │
│  main.py → ORQUESTADOR PRINCIPAL (ejecutado por GitHub Actions)             │
│  ├─ Llama modules en secuencia                                              │
│  └─ Coordina flujo completo                                                 │
│                                                                              │
│  backend/core/ → MÓDULOS DE NEGOCIO                                         │
│  ├─ api_client.py: Conexión API SIESA                                       │
│  ├─ business_rules.py: Validación facturas (tipos, montos)                  │
│  ├─ notas_credito_manager.py: Gestión de notas crédito (CRÍTICO)            │
│  ├─ excel_processor.py: Generación Excel con facturas                       │
│  └─ email_sender.py: Envío correos SMTP                                     │
│                                                                              │
│  backend/api/ → API REST (Flask)                                            │
│  ├─ app.py: Servidor con endpoints                                          │
│  ├─ auth.py: JWT + bcrypt                                                   │
│  └─ Endpoints: /api/login, /api/notas-credito, /api/resumen, etc.           │
│                                                                              │
│  backend/scripts/ → UTILIDADES                                              │
│  ├─ backup_database.py                                                      │
│  ├─ consultar_notas.py                                                      │
│  ├─ reporte_diario.py                                                       │
│  └─ 6 scripts más de mantenimiento                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ BASE DE DATOS (SQLite) ───────────────────────────────────────────────────┐
│                                                                              │
│  Archivo: data/notas_credito.db (749 KB, versionado en Git)                 │
│                                                                              │
│  TABLAS:                                                                     │
│  ├─ notas_credito: Notas registradas (0 registros)                          │
│  ├─ aplicaciones_notas: Historial de aplicaciones (0 registros)             │
│  ├─ facturas_rechazadas: Auditoría de rechazos (2,955 registros)            │
│  ├─ tipos_inventario_detectados: Catálogo tipos descubiertos (0)            │
│  ├─ usuarios: Accounts autenticación (1 - admin)                            │
│  ├─ sesiones: Token tracking JWT                                            │
│  └─ intentos_login: Auditoría acceso                                        │
│                                                                              │
│  PERSISTENCIA:                                                               │
│  └─ Commitida a Git después de cada ejecución diaria                        │
│  └─ Backup semanal en artifacts de GitHub (7 días)                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ FRONTEND (React + TypeScript) ────────────────────────────────────────────┐
│                                                                              │
│  Acceso: http://localhost:3000                                              │
│                                                                              │
│  PÁGINAS:                                                                    │
│  ├─ LoginPage: Autenticación JWT                                            │
│  ├─ DashboardPage: Resumen estadísticas de notas                            │
│  ├─ NotasPage: Listado con filtros                                          │
│  └─ NotaDetailPage: Detalle y historial aplicaciones                        │
│                                                                              │
│  FEATURES:                                                                   │
│  ├─ Auth JWT (auto-refresh de tokens)                                       │
│  ├─ Manejo localStorage                                                     │
│  ├─ Responsive design                                                       │
│  └─ Tailwind CSS                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. NOTAS CRÉDITO - CICLO DE VIDA                                            │
└─────────────────────────────────────────────────────────────────────────────┘

  RECIBIDA (API) → Prefijo 'N'
       ↓
  VALIDADA → Tipo inventario permitido
       ↓
  REGISTRADA → BD: estado = 'PENDIENTE'
       ↓
  APLICADA AUTOMÁTICAMENTE
       ├─ Busca facturas del MISMO cliente + MISMO producto
       ├─ Aplica: min(saldo_nota, valor_factura)
       ├─ Actualiza saldo_pendiente
       └─ Si saldo = 0 → Estado = 'APLICADA'
       ↓
  PERSISTIDA → Git (versionada)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. REGLAS DE NEGOCIO                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  TIPOS EXCLUIDOS (23 tipos):
  • VSMENORCC, VS4205101, INVMEDICAD, INV1430051, VS42100501
  • VS420515, VS42051003, VS420510, VSMENOR, INVFLETEPT
  • VSMENOR5%, VS42505090, INVFLETGEN, INV144542, INV144554
  • VSMAY-MECC, VSMAY-MECP, VSMAY-GEN, DESCESPEC, DESCUENTO
  • INV144562, VS425050, VS41200822, INV1460, VS41200819

  VALIDACIONES:
  ✓ Tipo inventario → Rechaza si está en lista excluida
  ✓ Monto mínimo → Rechaza si < $498,000 COP
  ✓ Notas crédito → Solo acepta si tipo inventario permitido

┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. REPORTES GENERADOS                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

  Excel: facturas_YYYYMMDD.xlsx
  ├─ Número, cliente, fecha, producto
  ├─ Cantidad, valor unitario, subtotal, IVA
  ├─ Valor total a cobrar
  └─ Notas de aplicación de crédito si aplica

  Txt: reporte_notas_credito_YYYYMMDD.txt
  ├─ Resumen: pendientes, aplicadas, saldo total
  └─ Detalle: aplicaciones realizadas HOY

  Txt: facturas_rechazadas_YYYYMMDD.txt
  ├─ Número, cliente, producto
  └─ Razón rechazo (tipo inventario, monto, etc.)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 7. AUTENTICACIÓN Y SEGURIDAD                                                │
└─────────────────────────────────────────────────────────────────────────────┘

  USUARIO INICIAL:
  • Username: admin
  • Password: admin123 (CAMBIAR EN PRODUCCIÓN)
  • Rol: admin

  SEGURIDAD:
  ✓ Password hash: bcrypt (cost 12)
  ✓ JWT: access_token (1 hora) + refresh_token (30 días)
  ✓ Rate limiting: 5 intentos fallidos → bloqueo 15 min
  ✓ Auditoría: todas las notas que se registren/apliquen
  ✓ IP tracking: registro de intentos por IP
  ✓ CORS: habilitado para desarrollo

  ROLES:
  • admin: Acceso completo
  • editor: Puede modificar datos
  • viewer: Solo lectura

┌─────────────────────────────────────────────────────────────────────────────┐
│ 8. AUTOMATIZACIÓN - GITHUB ACTIONS                                          │
└─────────────────────────────────────────────────────────────────────────────┘

  daily_process.yml
  ├─ Trigger: Diario 13:00 UTC (08:00 Bogotá) + Manual
  ├─ Job: Ejecuta main.py
  ├─ Secretos requeridos:
  │  ├─ CONNI_KEY, CONNI_TOKEN (API SIESA)
  │  ├─ EMAIL_USERNAME, EMAIL_PASSWORD
  │  ├─ SMTP_SERVER, SMTP_PORT
  │  └─ DESTINATARIOS
  ├─ Artifacts:
  │  ├─ Excel: 30 días
  │  ├─ Reportes TXT: 30 días
  │  └─ Backup BD: 7 días
  └─ Resultado: Commit de BD + Email automático

  backup_semanal.yml
  ├─ Trigger: Domingos 02:00 UTC (21:00 sábado Bogotá)
  ├─ Acción: Backup BD
  └─ Retención: 90 días

┌─────────────────────────────────────────────────────────────────────────────┐
│ 9. ARCHIVOS CLAVE                                                            │
└─────────────────────────────────────────────────────────────────────────────┘

  PROCESOS:
  ✓ backend/main.py (301 líneas) - Orquestador principal
  ✓ backend/export_operativa_custom.py (345) - Exportación personalizada

  MÓDULOS CRÍTICOS:
  ✓ backend/core/notas_credito_manager.py (670) - Gestión notas
  ✓ backend/core/business_rules.py (318) - Validaciones

  UTILIDADES:
  ✓ backend/core/api_client.py (139)
  ✓ backend/core/excel_processor.py (400+)
  ✓ backend/core/email_sender.py (106)
  ✓ backend/core/archivador_notas.py (400+)

  API REST:
  ✓ backend/api/app.py (1300+)
  ✓ backend/api/auth.py (426)

  SCRIPTS:
  ✓ backend/scripts/ (9 archivos)

  BASE DE DATOS:
  ✓ data/notas_credito.db (749 KB)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 10. ESTADÍSTICAS ACTUALES                                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Base de Datos:
  • Usuarios: 1 (admin)
  • Notas Crédito: 0
  • Aplicaciones: 0
  • Facturas Rechazadas: 2,955 (historial)

  Código:
  • Backend: ~3,000 líneas Python
  • Frontend: React + TypeScript
  • API: 1,389 líneas

┌─────────────────────────────────────────────────────────────────────────────┐
│ 11. STACK TECNOLÓGICO                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

  Backend:     Python 3.11 + Flask
  Frontend:    React 18 + TypeScript + Vite + Tailwind CSS
  BD:          SQLite
  Auth:        JWT + bcrypt
  API:         REST JSON
  Automatización: GitHub Actions
  DevOps:      Git + GitHub, Render.com (deployment)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 12. MONITOREO Y OPERACIÓN                                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  LOGS:
  • GitHub Actions: Disponible en Actions tab
  • Backend: Directorio logs/ (si configurado)
  • Base de datos: Tabla intentos_login y eventos

  VERIFICACIÓN:
  • Health check: GET /api/health
  • DB stats: GET /api/database-stats
  • Scripts de verificación disponibles

  ALERTAS:
  • Automáticamente por errores en GitHub Actions
  • Se pueden agregar notificaciones Slack/Email

╔════════════════════════════════════════════════════════════════════════════╗
║                              CONCLUSIÓN                                     ║
║                                                                             ║
║ Sistema totalmente AUTOMATIZADO que no requiere intervención manual         ║
║ más que configuración inicial. GitHub Actions se encarga de todo.           ║
║                                                                             ║
║ Responsables de operación: GitHub Actions                                  ║
║ Frecuencia: Diaria (8 AM Bogotá)                                           ║
║ Resultado: Reporte Excel + Histórico en BD + Estadísticas                  ║
║                                                                             ║
╚════════════════════════════════════════════════════════════════════════════╝
